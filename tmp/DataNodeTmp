package HDFSPackage;

import java.io.*;
import java.util.ArrayList;

import HDFSPackage.RequestResponse.*;
import java.rmi.Remote;
import java.rmi.RemoteException;
import java.rmi.registry.LocateRegistry;
import java.rmi.registry.Registry;
import java.rmi.server.UnicastRemoteObject;
public class DataNode extends UnicastRemoteObject implements IDataNode{

	protected DataNode() throws RemoteException {
		super();
		// TODO Auto-generated constructor stub
	}
	String directoryName = "blockDirectory";
	@Override
	public byte[] readBlock(byte[] input) throws RemoteException{
		// TODO Auto-generated method stub
		ReadBlockRequest readBlockRequest = new ReadBlockRequest(input);
		ReadBlockResponse readBlockResponse = new ReadBlockResponse();
		try{
			File file = new File(directoryName+"/"+readBlockRequest.blockNumber);
			if(file.exists()){
				FileInputStream fis = new FileInputStream(file);
				byte[] data = new byte[(int) file.length()];
				fis.read(data);
				readBlockResponse.data = data;
				readBlockResponse.status = 1;
				fis.close();
			}
			else{
				readBlockResponse.status = -1;
			}
		}
		catch(IOException e){
			e.printStackTrace();
		}
		//readBlockRequest.blockNumber;
		return readBlockResponse.toProto();
	}

	@Override
	public byte[] writeBlock(byte[] input) throws RemoteException{
		// TODO Auto-generated method stub
		// status successful = 1 unsuccessful = -1
		int status=1;
		WriteBlockRequest writeBlockRequest = new WriteBlockRequest(input);
		WriteBlockResponse writeBlockResponse = new WriteBlockResponse();
		File dir = new File(directoryName);
		if(!dir.exists()){
			dir.mkdir();
		}
		// write into file 
		try {
			BufferedWriter bw = new BufferedWriter(new FileWriter(directoryName+"/"+writeBlockRequest.blockInfo.blockNumber));
			bw.append(writeBlockRequest.data.toString());
			bw.flush();
			bw.close();
			
		} catch (IOException e) {
			// TODO Auto-generated catch block
			status=-1;
			e.printStackTrace();
		}
		/*Take data Node information from blockInfo Chaining call*/
		writeBlockResponse.status=status;
		return writeBlockResponse.toProto();
	}
	public static void main(String []args){
		try {
			Registry reg = LocateRegistry.createRegistry(1099);
			NameNode obj = new NameNode();
			reg.rebind("DataNode", obj);
			System.out.println("DataNode server is running");
		} catch (Exception e) {
			e.printStackTrace();
		}
	}

}

